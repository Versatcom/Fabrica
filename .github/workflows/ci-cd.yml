name: CI/CD

on:
  push:
    branches:
      - develop
      - staging
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build
        run: ./scripts/build.sh

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Test
        run: ./scripts/test.sh

  lint:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Lint
        run: ./scripts/lint.sh

  security:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Security Scan
        run: ./scripts/security_scan.sh

  deploy:
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main'
    environment: ${{
      github.ref == 'refs/heads/main' && 'prod' ||
      github.ref == 'refs/heads/staging' && 'staging' ||
      'dev'
    }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
      - name: Deploy
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" ]]; then
            STRATEGY="blue-green"
            ENVIRONMENT="prod"
          elif [[ "${GITHUB_REF}" == "refs/heads/staging" ]]; then
            STRATEGY="canary"
            ENVIRONMENT="staging"
          else
            STRATEGY="canary"
            ENVIRONMENT="dev"
          fi

          ./scripts/deploy.sh "${ENVIRONMENT}" "${STRATEGY}"
